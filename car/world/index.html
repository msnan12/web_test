<!DOCTYPE html>
<html lang="jp">
<meta charset="UTF-8">

<head>
    <title>World Editorçµ±åˆç‰ˆ</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <H1>Worldã€€Editorã€€ver0.2</H1>
    <canvas id="myCanvas"></canvas>
    <div id="controls">
        <label for="season-select">å­£ç¯€ã‚’é¸æŠ:</label>
        <select id="season-select" onchange="changeSeason()">
            <option value="spring">æ˜¥</option>
            <option value="summer">å¤</option>
            <option value="autumn">ç§‹</option>
            <option value="winter">å†¬</option>
        </select><br><br>

        <button title="é“è·¯ç·¨é›†" id="graphBtn" onclick="setMode('graph')">âœï¸</button>
        <button title="åœæ­¢ç·š" id="stopBtn" onclick="setMode('stop')">â›”ï¸</button>
        <button title="ä¸€æ™‚åœæ­¢" id="yieldBtn" onclick="setMode('yield')">âš ï¸</button>
        <button title="ä¿¡å·" id="crossingBtn" onclick="setMode('crossing')">ğŸš¶â€â™‚ï¸</button>
        <button title="é§è»Šã‚¹ãƒšãƒ¼ã‚¹" id="parkingBtn" onclick="setMode('parking')">ğŸ…¿ï¸</button>
        <button title="ä¿¡å·æ©Ÿ" id="LightBtn" onclick="setMode('Light')">ğŸš¥</button>
        <button title="è»Š" id="startBtn" onclick="setMode('start')">ğŸš—</button>
        <button title="ç›®çš„åœ°" id="targetBtn" onclick="setMode('target')">ğŸ“</button>
        
        <br><br>
        <button title="æ–°è¦" id="new" onclick="dispose()">ğŸ†•</button>
        <button title="ä¿å­˜" id="save" onclick="save()">ğŸ’¾</button>
        <label for="fileInput" class="file-input-label">ğŸ“
            <input 
                type="file"
                id="fileInput"
                accept=".world"
                onchange="load(event)"
            />
        </label>
        <!-- <button title="ä¿å­˜" id="save" onclick="openOsmPanel()">ğŸ—ºï¸</button> -->

        <!-- <div id="osmPanel" style="display:none;">
            <textarea id="osmDataContainer" rows="10" cols="50"
            placeholder="Paste OSM data here"></textarea>
            <div>
                <button onclick="parseOsmData()">âœ”ï¸</button>
                <button onclick="closeOsmPanel()">âŒ</button>
            </div>
        </div> -->
    </div>

    <script src="js/test.js"></script>
    <script src="js/world.js"></script>
    <script src="js/editors/graphEditor.js"></script>
    <script src="js/editors/markingEditor.js"></script>
    <script src="js/editors/stopEditor.js"></script>
    <script src="js/editors/crossingEditor.js"></script>
    <script src="js/editors/startEditor.js"></script>
    <script src="js/editors/yieldEditor.js"></script>
    <script src="js/editors/targetEditor.js"></script>
    <script src="js/editors/LightEditor.js"></script>
    <script src="js/editors/parkingEditor.js"></script>
    <script src="js/viewport.js"></script>
    <script src="js/marking/marking.js"></script>
    <script src="js/marking/yield.js"></script>
    <script src="js/marking/target.js"></script>
    <script src="js/marking/Light.js"></script>
    <script src="js/marking/parking.js"></script>
    <script src="js/marking/stop.js"></script>
    <script src="js/marking/crossing.js"></script>
    <script src="js/marking/start.js"></script>
    <script src="js/items/season.js"></script>
    <script src="js/items/tree.js"></script>
    <script src="js/items/building.js"></script>
    <script src="js/math/graph.js"></script>
    <script src="js/math/osm.js"></script>
    <script src="js/math/utils.js"></script>
    <script src="js/primitives/point.js"></script>
    <script src="js/primitives/segment.js"></script>
    <script src="js/primitives/polygon.js"></script>
    <script src="js/primitives/envelope.js"></script>

    <!-- <script src="saves/big.world"></script> -->
    <!-- <script src="saves/big_target.world"></script> -->
    <!-- <script src="saves/path_finding.world"></script> -->
    <script>
        // new Test().test1();
        myCanvas.width = 800;
        myCanvas.height = 600;
        
        const ctx = myCanvas.getContext("2d");

        const selectedSeason = document.getElementById("season-select").value;
        const currentSeason = Season.fromString(selectedSeason);

        const worldString = localStorage.getItem("world");
        const worldhInfo = worldString ? JSON.parse(worldString) : null;
        let world = worldhInfo
        ? World.load(worldhInfo)
        : new World(new Graph(),currentSeason);

        const graph = world.graph;
        

        // const world = new World(graph, currentSeason);

        const viewport = new ViewPort(myCanvas,world.zoom,world.offset);
        const tools={
            graph:{button: graphBtn, editor: new GraphEditor(viewport, graph)},
            stop:{button: stopBtn, editor: new StopEditor(viewport, world)},
            crossing:{button: crossingBtn, editor: new CrossingEditor(viewport, world)},
            start:{button: startBtn, editor: new StartEditor(viewport, world)},
            parking:{button: parkingBtn, editor: new ParkingEditor(viewport, world)},
            Light:{button: LightBtn, editor: new LightEditor(viewport, world)},
            target:{button:targetBtn, editor: new TargetEditor(viewport, world)},
            yield:{button: yieldBtn, editor: new YieldEditor(viewport, world)}
        }

        const posZero = new Point(0, 0);
        //const polytest=new Polygon([new Point(10,10),new Point(200,10),new Point(200,100),new Point(10,100)]);

        let oldGraphHas = graph.hash();
        setMode("graph");
        
        animate();
        // test();
        function test(){
            viewport.reset();
            
            // posZero.draw(ctx, { color: "yellow"});//debug

            if (graph.hash() != oldGraphHas) {
                world.generate();
                oldGraphHas = graph.hash();
            }
            const viewPoint = scale(viewport.getOffset(), -1)
            world.draw(ctx, viewPoint);
            ctx.globalAlpha = 0.3;
            for(const tool of Object.values(tools)){
                if(!tools['view']){
                    tool.editor.display();
                }
            }
        
            
            ctx.restore();
        }
        function animate() {
            viewport.reset();
            
            // posZero.draw(ctx, { color: "yellow"});//debug

            if (graph.hash() != oldGraphHas) {
                world.generate();
                oldGraphHas = graph.hash();
            }
            const viewPoint = scale(viewport.getOffset(), -1)
            world.draw(ctx, viewPoint);
            ctx.globalAlpha = 0.3;
            for(const tool of Object.values(tools)){
                if(!tools['view']){
                    tool.editor.display();
                }
            }
        
            
            ctx.restore();
            requestAnimationFrame(animate);
        }

        function dispose() {
            tools["graph"].editor.dispose();
            world.laneGuides.length=0;
            world.markings.length=0;
        }

        function save() {
            world.zoom=viewport.zoom;
            world.offset=viewport.offset;

            const element=document.createElement("a");
            element.setAttribute(
                "href",
                "data:application/json;charset=utf-8,"+
                encodeURIComponent("const world = World.load("
                    +JSON.stringify(world)
                    + ");")
            );

            const fileName="name.world";
            element.setAttribute("download",fileName);
            element.click();
            localStorage.setItem("world", JSON.stringify(world));
        }

        function load(event) {
            const file = event.target.files[0];
            if (!file) {
                alert("No file Select");
                return;
            }

            const reader = new FileReader();
            reader.readAsText(file);

            reader.onload = (evt) => {
                const fileContent = evt.target.result;
                const jsonString = fileContent.substring(
                    fileContent.indexOf("(") +1,
                    fileContent.lastIndexOf(")")
                );
                const jsonData = JSON.parse(jsonString);

                world = World.load(jsonData); // â† world å†ç”Ÿæˆ

                const select = document.getElementById("season-select");
                const name = world.season.name; // ä¾‹: "autumn"

                // value å±æ€§ã®ã‚ã‚‹ option ã‚’æ¢ã—ã¦å¼·åˆ¶é¸æŠ
                const option = [...select.options].find(opt => opt.value === name);
                if (option) {
                    select.value = name;
                    select.dispatchEvent(new Event("change")); // â† UIãƒ»çŠ¶æ…‹ã‚‚åŒæœŸã•ã›ã‚‹
                } else {
                    console.warn("ä¸æ˜ãªå­£ç¯€:", name);
                }

                localStorage.setItem("world", JSON.stringify(world));
                //location.reload();
                
            };
        }


        function changeSeason() {
            const selectedSeason = document.getElementById("season-select").value;
            const currentSeason = Season.fromString(selectedSeason);
            world.setSeason(currentSeason);
            world.generate();
        }

        function diseableEditors() {
            for (const tool of Object.values(tools)) {
                tool.button.classList.remove("active"); // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’å‰Šé™¤
                tool.button.classList.add("disabled");  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ç”¨ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                tool.editor.disable();
            }
        }

        function setMode(mode) { 
            diseableEditors();  
            tools[mode].button.classList.remove("disabled"); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è§£é™¤
            tools[mode].button.classList.add("active"); // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
            tools[mode].editor.enable();                   
        }

        function openOsmPanel(){
            osmPanel.style.display = "block";
        }

        function closeOsmPanel(){
            osmPanel.style.display = "none"
        }

        function parseOsmData(){
            if(osmDataContainer.value == ""){
                alert("Paste data first");
                return;
            }
            const res = Osm.parseRoads(JSON.parse(osmDataContainer.value));
            graph.points = res.points;
            graph.segments = res.segments;
            closeOsmPanel();
        }

    </script>
</body>

</html>